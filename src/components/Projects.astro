---
import { currentTheme } from '../config/theme.js';
import { getLangFromUrl, useTranslations } from '../i18n/utils.js';
import ProjectCard from './ProjectCard.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const validProjectTypes = {
  web: 'Web App',
  mobile: 'Mobile App',
  other: 'Other'
}

Object.freeze(validProjectTypes);

const projectImgBasePaths = '/assets/projects/imgs';
const projectVideoBasePaths = '/assets/projects/vids';

// Sample projects - you can modify this data
const projects = [
  {
    title: t('projectData.project1.title'),
    description: t('projectData.project1.description'),
    tech: ["Astro", "TypeScript", "Tailwind CSS"],
    github: "https://github.com/JotaErrE01/Portfolio-Astro",
    type: validProjectTypes.web,
    external: true,
    demo: "https://jotaerre.dev/",
    image: `${projectImgBasePaths}/blog.webp`,
  },
  {
    title: t('projectData.project2.title'),
    description: t('projectData.project2.description'),
    tech: ["React Native", "Expo", "Sqlite"],
    type: validProjectTypes.mobile,
    external: false,
    github: null,
    demo: "/conapp-demo",
    image: `${projectImgBasePaths}/ConApp.webp`,
    video: `${projectVideoBasePaths}/conapp.mp4`
  },
  {
    title: t('projectData.project3.title'),
    description: t('projectData.project3.description'),
    tech: ["Nextjs", "Redux", "Rtk Query"],
    type: validProjectTypes.web,
    external: false,
    github: null,
    demo: "/ecommerce-demo",
    image: `${projectImgBasePaths}/conauto-ecommerce.webp`,
    video: `${projectVideoBasePaths}/ecommerce.mp4`
  }
];
---

<section id="projects" class="container mx-auto px-6 py-20">
  <div class="text-center mb-16">
    <h2 class={`text-3xl md:text-5xl font-bold mb-4 ${currentTheme.text.primary}`}>
      {t('projects.title')}
    </h2>
    <p class={`text-lg md:text-xl max-w-2xl mx-auto ${currentTheme.text.secondary}`}>
      {t('projects.subtitle')}
    </p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {projects.map((project, index) => (
      <ProjectCard project={project} index={index} t={t} />
    ))}
  </div>
</section>

{/* Video Modal */}
<dialog id="video-modal" class="video-modal">
  <div class="modal-backdrop" onclick="closeVideoModal()"></div>
  
  <div class="modal-content-wrapper">
    <button 
      onclick="closeVideoModal()"
      class="close-btn"
      aria-label="Close modal"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    
    {/* Animated image - matches the clicked card image */}
    <img 
      id="modal-hero-image"
      src=""
      alt=""
      class="hero-image"
    />
    
    <div class="modal-content">
      <h2 id="modal-title" class="text-2xl md:text-3xl font-bold text-white mb-6"></h2>
      
      <video 
        id="modal-video"
        controls
        preload="metadata"
        class="modal-video"
      >
        Your browser doesn't support video.
      </video>
    </div>
  </div>
</dialog>

<script>
  // TypeScript declarations for global functions
  declare global {
    interface Window {
      openVideoModal: (videoSrc: string, title: string, imageSrc: string, imageIndex: number) => void;
      closeVideoModal: () => void;
    }
  }

  window.openVideoModal = function(videoSrc: string, title: string, imageSrc: string, imageIndex: number) {
    const modal = document.getElementById('video-modal') as HTMLDialogElement;
    const heroImage = document.getElementById('modal-hero-image') as HTMLImageElement;
    const video = document.getElementById('modal-video') as HTMLVideoElement;
    const titleEl = document.getElementById('modal-title') as HTMLHeadingElement;
    const modalContent = modal.querySelector('.modal-content') as HTMLElement;
    
    // Get the source image from the card
    const sourceImage = document.querySelector(`[data-image-index="${imageIndex}"]`) as HTMLImageElement;
    
    if (!sourceImage) return;

    // Get initial position of source image (FIRST)
    const sourceRect = sourceImage.getBoundingClientRect();
    
    // Setup hero image with source position
    heroImage.src = imageSrc;
    heroImage.style.position = 'fixed';
    heroImage.style.top = `${sourceRect.top}px`;
    heroImage.style.left = `${sourceRect.left}px`;
    heroImage.style.width = `${sourceRect.width}px`;
    heroImage.style.height = `${sourceRect.height}px`;
    heroImage.style.objectFit = 'cover';
    heroImage.style.borderRadius = '0.5rem';
    heroImage.style.zIndex = '10001';
    heroImage.style.opacity = '1';
    heroImage.style.transform = 'scale(1)';
    heroImage.style.transition = 'none';
    
    // Hide modal content initially
    modalContent.style.opacity = '0';
    titleEl.textContent = title;
    video.src = videoSrc;
    
    // Show modal
    modal.showModal();
    document.body.style.overflow = 'hidden';
    
    // Wait for next frame to start animation (LAST)
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        // Calculate final centered position
        const modalRect = modal.getBoundingClientRect();
        const finalWidth = Math.min(modalRect.width * 0.85, 1000);
        const finalHeight = finalWidth * (9/16); // 16:9 aspect ratio
        const finalTop = (modalRect.height - finalHeight) / 2 + modalRect.top;
        const finalLeft = (modalRect.width - finalWidth) / 2 + modalRect.left;
        
        // Animate to final position (INVERT & PLAY)
        heroImage.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
        heroImage.style.top = `${finalTop}px`;
        heroImage.style.left = `${finalLeft}px`;
        heroImage.style.width = `${finalWidth}px`;
        heroImage.style.height = `${finalHeight}px`;
        heroImage.style.borderRadius = '0.75rem';
        
        // After animation completes, show modal content and fade out image
        setTimeout(() => {
          heroImage.style.opacity = '0';
          heroImage.style.transition = 'opacity 0.3s ease-in-out';
          modalContent.style.opacity = '1';
          modalContent.style.transition = 'opacity 0.3s ease-in-out';
          
          // Start video after fade
          setTimeout(() => {
            video.play().catch(() => {
              // Autoplay might be blocked, that's ok
            });
          }, 200);
        }, 500);
      });
    });
  };

  window.closeVideoModal = function() {
    const modal = document.getElementById('video-modal') as HTMLDialogElement;
    const heroImage = document.getElementById('modal-hero-image') as HTMLImageElement;
    const video = document.getElementById('modal-video') as HTMLVideoElement;
    const modalContent = modal.querySelector('.modal-content') as HTMLElement;
    
    // Pause video
    video.pause();
    video.currentTime = 0;
    
    // Fade out modal
    modal.style.opacity = '0';
    modal.style.transition = 'opacity 0.2s ease-in-out';
    
    setTimeout(() => {
      modal.close();
      document.body.style.overflow = '';
      
      // Reset styles
      heroImage.style.opacity = '1';
      heroImage.style.transition = 'none';
      modalContent.style.opacity = '0';
      modal.style.opacity = '1';
      video.src = '';
    }, 200);
  };

  // Close on ESC key (native dialog behavior)
  const modal = document.getElementById('video-modal') as HTMLDialogElement;
  
  modal?.addEventListener('cancel', (e) => {
    e.preventDefault(); // Prevent default close
    window.closeVideoModal(); // Use our custom close
  });

  // Close when clicking backdrop
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      window.closeVideoModal();
    }
  });
</script>

<style>
  .video-modal {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    max-width: 100vw;
    max-height: 100vh;
    margin: 0;
    padding: 0;
    border: none;
    background: transparent;
    overflow: hidden;
  }

  .video-modal::backdrop {
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(8px);
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }

  .modal-content-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .hero-image {
    pointer-events: none;
    display: block;
  }

  .modal-content {
    position: relative;
    max-width: 1000px;
    width: 100%;
    z-index: 10000;
    opacity: 0;
  }

  .modal-video {
    width: 100%;
    max-width: 100%;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    max-height: 80vh;
  }

  .close-btn {
    position: fixed;
    top: 1.5rem;
    right: 1.5rem;
    z-index: 10002;
    width: 3rem;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 9999px;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }

  .close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
  }

  .close-btn:active {
    transform: rotate(90deg) scale(0.95);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .modal-content-wrapper {
      padding: 1rem;
    }

    .close-btn {
      width: 2.5rem;
      height: 2.5rem;
      top: 1rem;
      right: 1rem;
    }

    .modal-content h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
  }

  /* Smooth modal opening animation */
  .video-modal[open] {
    animation: modalFadeIn 0.2s ease-in-out;
  }

  @keyframes modalFadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>